"""
Configuration file for CC phasing MD analysis

Edit this file before running MD_fitting.ipynb
"""
import numpy as np

# =============================================================================
# OPTICS SELECTION
# =============================================================================
OPTICS = "Q26"  # "Q26" or "Q20"

# =============================================================================
# DATA ACQUISITION PARAMETERS
# =============================================================================
# If using get_data() in notebook (set if True in cell 2)
START_TIME = '2025-05-28 10:55:50'
END_TIME = '2025-05-28 11:24:55'
CYCLE_NAME = 'MD_CRAB_26_270_L8823_Q26_2025_V1'

# Or load from pickle file
DATA_FILE = "df_all_Q26.pkl"
USE_PICKLE = True  # Set False to use get_data() instead

# =============================================================================
# TIME WINDOWS #-2 w.r.t. Timber (in Timber 10:56 is -180)
# =============================================================================
windows = [
    ("m180", "2025-05-28 08:56:00", "2025-05-28 08:58:00"),
    ("m150", "2025-05-28 08:59:00", "2025-05-28 09:01:00"),
    ("m120", "2025-05-28 09:03:00", "2025-05-28 09:05:00"),
    ("m90",  "2025-05-28 09:06:00", "2025-05-28 09:08:00"),
    ("m60",  "2025-05-28 09:08:30", "2025-05-28 09:10:00"),
    ("m30",  "2025-05-28 09:10:40", "2025-05-28 09:12:30"),
    ("p0",   "2025-05-28 09:13:30", "2025-05-28 09:15:30"),
    ("p30",  "2025-05-28 09:16:00", "2025-05-28 09:18:00"),
    ("p60",  "2025-05-28 09:18:30", "2025-05-28 09:20:15"),
    ("p90",  "2025-05-28 09:21:00", "2025-05-28 09:22:40"),
    ("p120", "2025-05-28 09:23:10", "2025-05-28 09:24:45"),
]

# =============================================================================
# CTIME WINDOW (ms after injection)
# =============================================================================
# Common choices:
#   (1000, 6000)   - Early ramp, ~26 GeV
#   (6000, 12000)  - Mid ramp, ~50-100 GeV
#   (25000, 26000) - Flat top, ~450 GeV
t1_ms = 6000
t2_ms = 12000

# =============================================================================
# BEAM MOMENTUM [GeV/c]
# =============================================================================
MOMENTUM_GEV = 26.0  # Edit: 26, 270, or 450

# =============================================================================
# REFERENCE WINDOW
# =============================================================================
REFERENCE_LABEL = "m180"  # Usually "p0" or "m180"

# =============================================================================
# OPTICS FILES
# =============================================================================
OPTICS_FILES = {
    "Q26": "sps_q26_bpm_data.csv",
    "Q20": "sps_q20_bpm_data.csv",  # Create this if using Q20
}

# =============================================================================
# MACHINE TUNES
# =============================================================================
TUNES = {
    "Q26": {"Qx": 26.13, "Qy": 26.18},
    "Q20": {"Qx": 20.13, "Qy": 20.18},
}

# =============================================================================
# CRAB CAVITY OPTICS (from Head-Tail analysis)
# Reference: /afs/.../000_CCcalibration_HT/cmp_CC_parameters_t0_from_HT.ipynb
# =============================================================================

# Q26 optics
CC_OPTICS_Q26_H = [
    {
        "label": "CC1",
        "s": 1184.5878,
        "beta": 29.755513884278752,  # H-plane beta [m]
        "mu": 8.190695622776744 / (2*np.pi),  # H-plane phase
    },
]

CC_OPTICS_Q26_V = [
    {
        "label": "CC1",
        "s": 1184.5878,
        "beta": 78.90425201740106,  # V-plane beta [m]
        "mu": 8.21949268189431 / (2*np.pi),  # V-plane phase
    },
]

# Q20 optics
CC_OPTICS_Q20_H = [
    {
        "label": "CC1",
        "s": 1184.5878,
        "beta": 41.49857653306058,  # H-plane beta [m]
        "mu": 6.309963849369042 / (2*np.pi),  # H-plane phase
    },
]

CC_OPTICS_Q20_V = [
    {
        "label": "CC1",
        "s": 1184.5878,
        "beta": 83.6763468473442,  # V-plane beta [m]
        "mu": 6.334214602764455 / (2*np.pi),  # V-plane phase
    },
]

# Automatic selection based on OPTICS variable
CC_OPTICS = {
    "Q26": {"H": CC_OPTICS_Q26_H, "V": CC_OPTICS_Q26_V},
    "Q20": {"H": CC_OPTICS_Q20_H, "V": CC_OPTICS_Q20_V},
}

# =============================================================================
# PHASE MAPPING (degrees)
# =============================================================================
phase_deg = {
    "m180": -180, "m150": -150, "m120": -120, "m90": -90,
    "m60": -60, "m30": -30, "p0": 0, "p30": 30,
    "p60": 60, "p90": 90, "p120": 120,
}

# =============================================================================
# DERIVED PARAMETERS (auto-calculated, no need to edit)
# =============================================================================
optics_file = OPTICS_FILES[OPTICS]
Qx = TUNES[OPTICS]["Qx"]
Qy = TUNES[OPTICS]["Qy"]
cc_optics_H = CC_OPTICS[OPTICS]["H"]
cc_optics_V = CC_OPTICS[OPTICS]["V"]
